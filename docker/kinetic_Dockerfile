FROM ubuntu:16.04

MAINTAINER Eiji Uchibe <uchibe@atr.jp>

############################################
# General setup
############################################
# Basic utilities
RUN apt-get -y update \
    && apt-get install -y git screen tree sudo ssh synaptic \
    locales lsb-release

############################################
# ROS
# http://wiki.ros.org/kinetic/Installation/Ubuntu
############################################
# Setup environment
RUN locale-gen en_US.UTF-8
ENV LANG en_US.UTF-8

# Set up sources.list
RUN echo "deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main" > /etc/apt/sources.list.d/ros-latest.list

# Set up your keys
RUN apt-key adv --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-key 421C365BD9FF1F717815A3895523BAEEB01FA116

# Installation
RUN apt-get update && apt-get install -y ros-kinetic-desktop-full
RUN apt-get install -y python-rosinstall python-rosinstall-generator \
    python-wstool build-essential

# bootstrap rosdep
RUN rosdep init \
    && rosdep update

RUN echo "source /opt/ros/kinetic/setup.bash" >> ~/.bashrc
ENV BASH_ENV ~/.bashrc

############################################
# OpenAI Gym
############################################
RUN apt-get update --fix-missing \
    && apt-get install -y python-numpy \
    python-matplotlib \
    python-dev cmake \
    zlib1g-dev libjpeg-dev xvfb libav-tools xorg-dev \
    python-opengl python-pip \
    libboost-all-dev libsdl2-dev swig

RUN pip install --upgrade pip
RUN pip install 'gym[all]'

############################################
# Gazebo
############################################
# setup environment
EXPOSE 11345

# Install additional dependencies
RUN apt-get install -y ros-kinetic-cv-bridge \
    ros-kinetic-robot-state-publisher

############################################
# Theano and Keras
#   Tensorflow is also installed with Keras
############################################
RUN pip install h5py
RUN apt-get install -y gfortran python-skimage psmisc
RUN pip install Theano keras
ENV KERAS_BACKEND=theano


############################################
# Gym-Gazebo
############################################
RUN apt-get update \
    && apt-get install -y git mercurial \
    libsdl-image1.2-dev libspnav-dev libtbb-dev \
    libtbb2 libusb-dev libftdi-dev \
    pyqt4-dev-tools python-vcstool python-pip \
    g++ ccache realpath \
    libopencv-dev libtool libtool-bin libexpat1-dev libtinyxml2-dev \
    automake autoconf gawk psmisc

RUN apt-get update \
    && apt-get install -y ros-kinetic-bfl \
    ros-kinetic-mavlink ros-kinetic-octomap-msgs \
    ros-kinetic-octomap-ros \
    ros-kinetic-joy ros-kinetic-geodesy \
    ros-kinetic-control-toolbox \
    ros-kinetic-pluginlib \
    ros-kinetic-navigation \
    ros-kinetic-trajectory-msgs \
    ros-kinetic-control-msgs \
    ros-kinetic-std-srvs \
    ros-kinetic-nodelet \
    ros-kinetic-urdf \
    ros-kinetic-rviz \
    ros-kinetic-kdl-conversions \
    ros-kinetic-eigen-conversions \
    ros-kinetic-tf2-sensor-msgs \
    ros-kinetic-pcl-ros 

#RUN easy_install numpy
#RUN easy_install --upgrade numpy
#RUN pip install --upgrade matplotlib
RUN pip2 install pymavlink MAVProxy catkin_pkg --upgrade

# Install Sophus
WORKDIR /opt
RUN git clone --depth 1 https://github.com/stonier/sophus -b indigo \
    && mkdir -p sophus/build \
    && cd sophus/build \
    && cmake .. \
    && make \
    && make install

# Install APM/Ardupilot
RUN mkdir apm \
    && cd apm \
    && git clone --depth 1 https://github.com/erlerobot/ardupilot.git -b gazebo_udp \
    && git clone --depth 1 https://github.com/tridge/jsbsim.git \
    && cd jsbsim \
    && ./autogen.sh --enable-libraries \
    && make \
    && make install

# Download and install gym-gazebo
RUN git clone --depth 1 https://github.com/erlerobot/gym-gazebo.git \
    && cd gym-gazebo \
    && pip install -e .

# Install dependencies
RUN apt-get update \
    && apt-get install -y libbluetooth-dev libcwiid1 \
    libcwiid-dev lswm wmgui wminput
ADD docker/kinetic_gazebo.repos /tmp/gazebo.repos

ENV HOME /root

RUN /bin/bash -c "source /opt/ros/kinetic/setup.bash \
    && mkdir -p ${HOME}/catkin_ws/src \
    && cd ${HOME}/catkin_ws/src \
    && catkin_init_workspace \
    && cd .. \
    && catkin_make"
RUN /bin/bash -c "cd ${HOME}/catkin_ws/src \
    && vcs import < /tmp/gazebo.repos"
#RUN apt-get install -y siv-dev python-qt4-dev python-sip-dev pyqt4-dev-tools
#RUN /bin/bash -c "source /opt/ros/kinetic/setup.bash \
#   && cd ${HOME}/catkin_ws \
#    && catkin_make --pkg mav_msgs \
#    && source devel/setup.bash \
#    && catkin_make -j 1"


############################################
# locate
############################################
RUN apt-get update \
    && apt-get install -y mlocate \
    && updatedb
